<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hợp đồng & Yêu cầu của tôi</title>

    <!-- CSS chung của project -->
    <link rel="stylesheet" th:href="@{/dashboard/css/main.css}">
    <!-- CSS riêng cho trang danh sách -->
    <link rel="stylesheet" th:href="@{/customer/css/my-requests.css}">
</head>
<body>

<!-- Nếu dùng navbar fragment -->
<!-- <th:block th:replace="fragments/navbar :: navbar"></th:block> -->

<div class="fm-page">

    <!-- Stepper (flow của user) -->
    <div class="fm-stepper">
        <div class="fm-step fm-step--active"><span>1. Hợp đồng & Yêu cầu</span></div>
        <div class="fm-step"><span>2. Thanh toán</span></div>
        <div class="fm-step"><span>3. Thực hiện</span></div>
        <div class="fm-step"><span>4. Hoàn tất</span></div>
        <div class="fm-step"><span>5. Đánh giá</span></div>
    </div>

    <div class="fm-layout">

        <!-- Cột trái: danh sách yêu cầu -->
        <section class="fm-card">

            <div class="fm-card-header">
                <div>
                    <div class="fm-card-title">Danh sách</div>
                    <div class="fm-card-subtitle">Hợp đồng & Yêu cầu của tôi</div>
                </div>
            </div>

            <!-- Filter bằng chip -->
            <div class="fm-filter-row">
                <a th:href="@{/customer/requests}" class="fm-chip"
                   th:classappend="${selectedStatus == 'ALL'} ? ' fm-chip--active'">Tất cả</a>

                <a th:href="@{/customer/requests(status='pending')}" class="fm-chip"
                   th:classappend="${selectedStatus == 'pending'} ? ' fm-chip--active'">Đang chờ</a>

                <a th:href="@{/customer/requests(status='ready_to_pay')}" class="fm-chip"
                   th:classappend="${selectedStatus == 'ready_to_pay'} ? ' fm-chip--active'">Chờ thanh toán</a>

                <a th:href="@{/customer/requests(status='paid')}" class="fm-chip"
                   th:classappend="${selectedStatus == 'paid'} ? ' fm-chip--active'">Đã thanh toán</a>

                <a th:href="@{/customer/requests(status='in_progress')}" class="fm-chip"
                   th:classappend="${selectedStatus == 'in_progress'} ? ' fm-chip--active'">Đang thực hiện</a>

                <a th:href="@{/customer/requests(status='completed')}" class="fm-chip"
                   th:classappend="${selectedStatus == 'completed'} ? ' fm-chip--active'">Hoàn tất</a>

                <a th:href="@{/customer/requests(status='cancelled')}" class="fm-chip"
                   th:classappend="${selectedStatus == 'cancelled'} ? ' fm-chip--active'">Đã huỷ</a>
            </div>

            <!-- Nếu không có request -->
            <div class="fm-empty" th:if="${#lists.isEmpty(requests)}">
                Bạn chưa có hợp đồng / yêu cầu nào.
            </div>

            <!-- Danh sách request -->
            <div class="fm-request-list">

                <div class="fm-request-item" th:each="r : ${requests}">

                    <!-- Column 1 -->
                    <div class="fm-req-main">

                        <div class="fm-req-id">
                            Yêu cầu #<span th:text="${r.requestId}">1</span>
                        </div>

                        <div class="fm-req-row">
                            <div>
                                <div class="fm-req-label">Ngày yêu cầu</div>
                                <div class="fm-req-val"
                                     th:text="${#temporals.format(r.requestDate, 'dd/MM/yyyy HH:mm')}">01/11/2025</div>
                            </div>

                            <div>
                                <div class="fm-req-label">Ngày ưu tiên</div>
                                <div class="fm-req-val"
                                     th:text="${#temporals.format(r.preferredDate, 'dd/MM/yyyy')}">02/11/2025</div>
                            </div>
                        </div>

                        <div class="fm-req-row" style="margin-top: 8px;">

                            <!-- CONTRACT BADGE -->
                            <div class="fm-badge fm-badge--contract">
                                <span class="fm-badge-dot"></span>
                                <span>
                                    HĐ:
                                    <span th:if="${r.contractId != null && contractsMap[r.contractId] != null}"
                                          th:text="${contractsMap[r.contractId].status + ' #' + r.contractId}">
                                    </span>
                                    <span th:unless="${r.contractId != null && contractsMap[r.contractId] != null}">
                                        Chưa tạo
                                    </span>
                                </span>
                            </div>

                            <!-- REQUEST STATUS -->
                            <div class="fm-badge" th:classappend="' status-' + ${r.status}">
                                <span class="fm-badge-dot"></span>
                                <span th:text="${r.status}"></span>
                            </div>

                            <!-- PAYMENT -->
                            <div class="fm-badge" th:if="${r.paymentStatus != null}">
                                <span class="fm-badge-dot"></span>
                                <span th:text="'Thanh toán: ' + ${r.paymentStatus}"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2 -->
                    <div class="fm-req-main">
                        <div class="fm-req-label">Tổng chi phí (ước tính)</div>
                        <div class="fm-req-amount"
                             th:text="${r.totalCost != null ? #numbers.formatDecimal(r.totalCost, 0, 'COMMA', 0, 'POINT') + ' đ' : '—'}">
                            600.000 đ
                        </div>

                        <div class="fm-req-row" style="margin-top: 10px;">
                            <div>
                                <div class="fm-req-label">Ngày ký HĐ</div>
                                <div class="fm-req-val">
                                    <span th:if="${r.contractId != null &&
                                                  contractsMap[r.contractId] != null &&
                                                  contractsMap[r.contractId].signedAt != null}"
                                          th:text="${#temporals.format(contractsMap[r.contractId].signedAt, 'dd/MM/yyyy HH:mm')}">
                                    </span>
                                    <span th:unless="${r.contractId != null &&
                                                      contractsMap[r.contractId] != null &&
                                                      contractsMap[r.contractId].signedAt != null}">
                                        —
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 3 (actions) -->
                    <div style="text-align: right;">
                        <a th:href="@{|/customer/requests/${r.requestId}|}" class="fm-link-detail">
                            Xem chi tiết
                        </a>
                    </div>

                </div>
            </div>
        </section>

        <!-- Cột phải: tổng quan -->
        <aside class="fm-card">
            <div class="fm-card-header">
                <div class="fm-card-title">Tổng quan</div>
                <div class="fm-card-subtitle">Tóm tắt & Gợi ý</div>
            </div>

            <p style="font-size: 13px; color: #a5afce; margin-bottom: 8px;">
                Trang này hiển thị toàn bộ <strong>hợp đồng</strong> và
                <strong>yêu cầu dịch vụ</strong> mà bạn đã tạo.
            </p>

            <ul style="font-size: 13px; color: #c3c9ea; padding-left: 18px; margin-top: 6px;">
                <li>Bấm vào <strong>chip trạng thái</strong> để lọc nhanh.</li>
                <li>Nhấn <strong>Xem chi tiết</strong> để xem địa chỉ, lịch hẹn, gói dịch vụ.</li>
                <li>Nếu trạng thái là <strong>ready_to_pay</strong>, bạn sẽ thấy nút thanh toán trong trang chi tiết.</li>
            </ul>
        </aside>
    </div>
</div>

</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết yêu cầu</title>

    <!-- CSRF meta -->
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">

    <!-- CSS Libraries for navbar and footer -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/homepage/css/style.css}" rel="stylesheet">

    <!-- CSS chung của project (nếu có) -->
    <link rel="stylesheet" th:href="@{/dashboard/css/main.css}">
    <!-- CSS riêng cho trang chi tiết -->
    <link rel="stylesheet" th:href="@{/customer/css/request-detail.css}">

    <!-- Style nhỏ cho rating -->
    <style>
        .rating-stars .star {
            font-size: 1.8rem;
            cursor: pointer;
            margin-right: 0.25rem;
            transition: transform 0.1s ease-in-out;
        }

        .rating-stars .star.active {
            color: #ffc107;
        }

        .rating-stars .star:hover {
            transform: scale(1.1);
        }

        .fm-rating-note {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<div th:replace="fragments/navbar :: navbar"></div>

<!-- gắn data-request-id để JS đọc -->
<div class="fm-page fm-detail-root"
     th:attr="data-request-id=${request.requestId}">

    <!-- Stepper trạng thái flow -->
    <div class="fm-stepper">
        <div class="fm-step"
             th:classappend="${request.status == 'pending'} ? ' fm-step--active' : ''">
            <span>1. Hợp đồng & Yêu cầu</span>
        </div>
        <div class="fm-step"
             th:classappend="${request.status == 'ready_to_pay' or request.status == 'paid'} ? ' fm-step--active' : ''">
            <span>2. Thanh toán</span>
        </div>
        <div class="fm-step"
             th:classappend="${request.status == 'in_progress'} ? ' fm-step--active' : ''">
            <span>3. Thực hiện</span>
        </div>
        <div class="fm-step"
             th:classappend="${request.status == 'completed'} ? ' fm-step--active' : ''">
            <span>4. Hoàn tất</span>
        </div>
        <div class="fm-step">
            <span>5. Đánh giá</span>
        </div>
    </div>

    <div class="fm-detail-layout">

        <!-- Cột trái: thông tin yêu cầu -->
        <section class="fm-card fm-card--primary">
            <div class="fm-card-header">
                <div class="fm-card-title">Yêu cầu dịch vụ</div>
                <div class="fm-card-subtitle">
                    Yêu cầu #<span th:text="${request.requestId}">1</span>
                </div>
            </div>

            <!-- Trạng thái & lịch hẹn -->
            <div class="fm-section">
                <div class="fm-section-title">Trạng thái & lịch hẹn</div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">Trạng thái yêu cầu</div>
                        <div>
                            <span class="fm-badge fm-badge--request js-status"
                                  th:classappend="' status-' + ${request.status}">
                                <span class="fm-badge-dot"></span>
                                <span th:text="${
                                        request.status == 'pending' ? 'Đang chờ xác nhận' :
                                        request.status == 'ready_to_pay' ? 'Chờ thanh toán' :
                                        request.status == 'paid' ? 'Đã thanh toán' :
                                        request.status == 'in_progress' ? 'Đang thực hiện' :
                                        request.status == 'completed' ? 'Hoàn tất dịch vụ' :
                                        request.status == 'cancelled' ? 'Đã huỷ' :
                                        request.status
                                }"></span>
                            </span>
                        </div>
                    </div>

                    <div>
                        <div class="fm-label">Trạng thái thanh toán</div>
                        <div>
                            <!-- Badge thanh toán: luôn có trong DOM, JS sẽ ẩn/hiện -->
                            <span class="fm-badge fm-badge--payment js-payment-status"
                                  th:classappend="${request.paymentStatus != null} ? '' : ' d-none'">
                                <span class="fm-badge-dot"></span>
                                <span th:text="${
                                        request.paymentStatus == 'PENDING' ? 'Chưa thanh toán' :
                                        request.paymentStatus == 'PAID' ? 'Đã thanh toán' :
                                        request.paymentStatus == 'FAILED' ? 'Thanh toán thất bại' :
                                        request.paymentStatus == 'READY_TO_PAY' ? 'Chờ thanh toán' :
                                        request.paymentStatus
                                }"></span>
                            </span>
                            <span class="fm-value js-payment-empty"
                                  th:classappend="${request.paymentStatus == null} ? '' : ' d-none'">—</span>
                        </div>
                    </div>
                </div>

                <div class="fm-grid-2col" style="margin-top: 4px;">
                    <div>
                        <div class="fm-label">Ngày yêu cầu</div>
                        <div class="fm-value"
                             th:text="${#temporals.format(request.requestDate, 'dd/MM/yyyy HH:mm')}">
                        </div>
                    </div>
                    <div>
                        <div class="fm-label">Ngày ưu tiên</div>
                        <div class="fm-value"
                             th:text="${#temporals.format(request.preferredDate, 'dd/MM/yyyy')}">
                        </div>
                    </div>
                    <div>
                        <div class="fm-label">Thời điểm thanh toán</div>
                        <div class="fm-value js-paid-at">
                            <span th:if="${request.paidAt != null}"
                                  th:text="${#temporals.format(request.paidAt, 'dd/MM/yyyy HH:mm')}">
                            </span>
                            <span th:if="${request.paidAt == null}">—</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- THÔNG TIN HỦY ĐƠN (customer nhìn thấy lý do hủy) -->
            <div class="fm-section"
                 th:if="${hasCancellationInfo}">
                <div class="fm-section-title text-danger">Thông tin hủy đơn</div>

                <p class="mb-1">
                    <strong>Trạng thái:</strong>
                    <span th:text="${request.status == 'cancelled' ? 'Đơn hàng đã bị hủy' : 'Yêu cầu hủy đã được xử lý'}">
                        Đơn hàng đã bị hủy
                    </span>
                </p>

                <p class="mb-1" th:if="${cancelledByHuman != null}">
                    <strong>Bên hủy:</strong>
                    <span th:text="${cancelledByHuman}">Bạn (khách hàng)</span>
                </p>

                <p class="mb-1"
                   th:if="${request.cancelReason != null}">
                    <strong>Lý do hủy:</strong>
                    <span th:text="${request.cancelReason}">Khách thay đổi kế hoạch</span>
                </p>

                <p class="mb-1"
                   th:if="${request.cancelledAt != null}">
                    <strong>Thời điểm hủy:</strong>
                    <span th:text="${#temporals.format(request.cancelledAt, 'dd/MM/yyyy HH:mm')}">
                        01/01/2025 12:00
                    </span>
                </p>

                <!-- Nếu có bản ghi CancellationRequest (hủy sau thanh toán) -->
                <p class="mb-1"
                   th:if="${latestCancellation != null and latestCancellation.decisionNote != null}">
                    <strong>Ghi chú từ đơn vị vận chuyển:</strong>
                    <span th:text="${latestCancellation.decisionNote}">
                        Sẽ hoàn tiền 90% cho khách.
                    </span>
                </p>

                <p class="mb-0 small text-muted"
                   th:if="${latestCancellation != null}">
                    Trạng thái yêu cầu hủy:
                    <span th:text="${latestCancellation.status}">approved</span>
                </p>
            </div>
            <!-- HẾT THÔNG TIN HỦY ĐƠN -->

            <!-- Thông tin chi phí -->
            <div class="fm-section">
                <div class="fm-section-title">Chi phí</div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">Tổng chi phí</div>
                        <div class="fm-price-main js-total"
                             th:text="${request.totalCost != null
                                       ? #numbers.formatDecimal(request.totalCost, 0, 'COMMA', 0, 'POINT') + ' đ'
                                       : '—'}">
                        </div>
                    </div>
                    <div>
                        <div class="fm-label">Hình thức thanh toán</div>
                        <div class="fm-value js-payment-type"
                             th:text="${
                                request.paymentType == null ? '—' :
                                request.paymentType == 'DEPOSIT_20' ? 'Đặt cọc 20%' :
                                request.paymentType == 'FULL' ? 'Thanh toán toàn bộ' :
                                request.paymentType
                             }">
                        </div>
                    </div>
                </div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">Số tiền đặt cọc</div>
                        <div class="fm-value js-deposit"
                             th:text="${request.depositAmount != null
                                       ? #numbers.formatDecimal(request.depositAmount, 0, 'COMMA', 0, 'POINT') + ' đ'
                                       : '—'}">
                        </div>
                    </div>
                </div>

                <div class="fm-highlight-box">
                    Chi phí hiển thị chỉ mang tính chất tham khảo. Giá cuối cùng có thể điều chỉnh theo
                    khối lượng đồ đạc thực tế, quãng đường và điều khoản trong hợp đồng.
                </div>
            </div>

            <!-- KHU VỰC ĐÁNH GIÁ -->
            <div class="fm-section js-rating-section" id="rating-section" style="display:none;">

                <div class="fm-section-title d-flex justify-content-between align-items-center">
                    <span>Đánh giá dịch vụ</span>
                    <button type="button"
                            class="btn btn-sm btn-link text-muted js-rating-close">
                        <i class="fa fa-times"></i> Đóng
                    </button>
                </div>

                <div class="fm-row">
                    <div class="fm-label">Mức độ hài lòng</div>
                    <div class="fm-value">
                        <div id="rating-stars" class="rating-stars js-rating-stars">
                            <i class="fa fa-star star" data-value="1"></i>
                            <i class="fa fa-star star" data-value="2"></i>
                            <i class="fa fa-star star" data-value="3"></i>
                            <i class="fa fa-star star" data-value="4"></i>
                            <i class="fa fa-star star" data-value="5"></i>
                        </div>
                        <div class="fm-rating-note">
                            Chọn từ 1 đến 5 sao (1: Rất không hài lòng, 5: Rất hài lòng)
                        </div>
                    </div>
                </div>

                <div class="fm-row" style="margin-top: 8px;">
                    <div class="fm-label">Góp ý thêm (không bắt buộc)</div>
                    <div class="fm-value" style="width:100%;">
                        <textarea id="rating-comment"
                                  class="form-control js-rating-comment"
                                  rows="3"
                                  placeholder="Ví dụ: Nhân viên thân thiện, đến đúng giờ, đồ đạc được bảo quản tốt..."></textarea>
                    </div>
                </div>

                <div class="fm-row" style="margin-top: 8px;">
                    <button type="button"
                            id="rating-submit-btn"
                            class="fm-btn-primary js-rating-submit">
                        Gửi đánh giá
                    </button>
                </div>

                <div class="fm-row" style="margin-top: 4px;">
                    <small id="rating-status"
                           class="text-muted js-rating-status"></small>
                </div>
            </div>
            <!-- Hết khu vực rating -->

        </section>

        <!-- Cột phải: tóm tắt HĐ & hành động -->
        <aside class="fm-card fm-card--side">

            <div class="fm-card-header">
                <div class="fm-card-title">Tổng quan</div>
                <div class="fm-card-subtitle">Hợp đồng & thanh toán</div>
            </div>

            <!-- Thông tin Hợp đồng -->
            <div class="fm-section">
                <div class="fm-section-title">Hợp đồng</div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">Mã hợp đồng</div>
                    </div>
                    <div class="fm-value">
                        <span class="js-contract-id"
                              th:if="${contract != null}"
                              th:text="${contract.contractId}">101</span>
                        <span th:if="${contract == null}">Chưa có</span>
                    </div>
                </div>

                <div class="fm-row" th:if="${contract != null}">
                    <div>
                        <div class="fm-label">Trạng thái HĐ</div>
                    </div>
                    <div class="fm-value">
                        <span class="fm-badge fm-badge--contract js-contract-status">
                            <span class="fm-badge-dot"></span>
                            <span th:text="${
                                contract.status == 'draft' ? 'Chưa ký' :
                                contract.status == 'signed' ? 'Đã ký' :
                                contract.status == 'acknowledged' ? 'Đơn vị vận chuyển đã xác nhận' :
                                contract.status == 'cancelled' ? 'Hợp đồng bị huỷ' :
                                contract.status
                            }">
                                Đã ký
                            </span>
                        </span>
                    </div>
                </div>

                <div class="fm-grid-2col" th:if="${contract != null}">
                    <div>
                        <div class="fm-label">Ngày ký HĐ</div>
                        <div class="fm-value js-contract-signed">
                            <span th:if="${contract.signedAt != null}"
                                  th:text="${#temporals.format(contract.signedAt, 'dd/MM/yyyy HH:mm')}">
                            </span>
                            <span th:if="${contract.signedAt == null}">—</span>
                        </div>
                    </div>

                    <div>
                        <div class="fm-label">Đơn vị vận chuyển xác nhận</div>
                        <div class="fm-value js-contract-ack">
                            <span th:if="${contract.acknowledgedAt != null}"
                                  th:text="${#temporals.format(contract.acknowledgedAt, 'dd/MM/yyyy HH:mm')}">
                            </span>
                            <span th:if="${contract.acknowledgedAt == null}">—</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hành động -->
            <div class="fm-section">
                <div class="fm-section-title">Hành động</div>

                <div class="fm-actions">
                    <!-- Đi đến thanh toán: luôn render, ẩn/hiện bằng JS -->
                    <a class="fm-btn-primary js-payment-btn"
                       th:href="@{|/payment/${request.requestId}|}"
                       th:classappend="${
                           (request.status == 'ready_to_pay'
                               or (request.status == 'pending' and request.providerId != null))
                           and (request.paymentStatus == null or request.paymentStatus != 'PAID')
                       } ? '' : ' d-none'">
                        Đi đến thanh toán
                    </a>

                    <!-- HỦY ĐƠN: dùng boolean canCancel từ backend (giai đoạn 1) -->
                    <button type="button"
                            class="btn btn-danger btn-sm fm-btn-danger js-cancel-request"
                            th:classappend="${canCancel} ? '' : ' d-none'">
                        Hủy đơn
                    </button>

                    <!-- YÊU CẦU HỦY ĐƠN: giai đoạn 2 (sau khi đã thanh toán, chờ provider xét duyệt) -->
                    <button type="button"
                            class="fm-btn-ghost js-cancel-request-paid"
                            th:classappend="${canRequestCancel} ? '' : ' d-none'">
                        Yêu cầu hủy đơn
                    </button>

                    <!-- Nút "Xem hợp đồng" (xem-only) -->
                    <a class="fm-btn-ghost"
                       th:if="${contract != null}"
                       th:href="@{|/customer/requests/${request.requestId}/contract|}">
                        Xem hợp đồng
                    </a>

                    <!-- Nút "Đánh giá" (JS sẽ tự xử lý hiển thị) -->
                    <button type="button"
                            id="open-rating-btn"
                            class="fm-btn-ghost js-rating-open"
                            style="display:none;">
                        Đánh giá
                    </button>
                </div>

                <!-- Thông báo nếu đã gửi yêu cầu hủy và đang chờ xử lý -->
                <div class="fm-note fm-note-warning js-pending-cancel-note"
                     th:classappend="${hasPendingCancel} ? '' : ' d-none'">
                    Bạn đã gửi yêu cầu hủy đơn. Đơn vị vận chuyển sẽ xem xét và phản hồi.
                </div>
            </div>

        </aside>
    </div>

    <a th:href="@{/customer/requests}" class="fm-back-link">
        ← Quay lại danh sách
    </a>
</div>

<!-- JS cho trang detail (cancel / rating, v.v.) -->
<script th:src="@{/customer/js/request-detail.js}"></script>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>

<!-- JavaScript Libraries for navbar and footer -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/homepage/lib/wow/wow.min.js}"></script>
<script th:src="@{/homepage/js/main.js}"></script>

</body>
</html>

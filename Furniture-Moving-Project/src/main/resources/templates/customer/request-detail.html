<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi ti·∫øt y√™u c·∫ßu</title>

    <!-- CSS Libraries for navbar and footer -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/homepage/css/style.css}" rel="stylesheet">

    <!-- CSS chung c·ªßa project (n·∫øu c√≥) -->
    <link rel="stylesheet" th:href="@{/dashboard/css/main.css}">
    <!-- CSS ri√™ng cho trang chi ti·∫øt -->
    <link rel="stylesheet" th:href="@{/customer/css/request-detail.css}">

    <!-- Style nh·ªè cho rating (c√≥ th·ªÉ chuy·ªÉn sang request-detail.css n·∫øu mu·ªën) -->
    <style>
        .rating-stars .star {
            font-size: 1.8rem;
            cursor: pointer;
            margin-right: 0.25rem;
            transition: transform 0.1s ease-in-out;
        }

        .rating-stars .star.active {
            color: #ffc107;
        }

        .rating-stars .star:hover {
            transform: scale(1.1);
        }

        .fm-rating-note {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<div th:replace="fragments/navbar :: navbar"></div>

<!-- ‚úÖ g·∫Øn data-request-id ƒë·ªÉ JS realtime ƒë·ªçc -->
<div class="fm-page fm-detail-root"
     th:attr="data-request-id=${request.requestId}">

    <!-- Stepper tr·∫°ng th√°i flow -->
    <div class="fm-stepper">
        <div class="fm-step"
             th:classappend="${request.status == 'pending'} ? ' fm-step--active' : ''">
            <span>1. H·ª£p ƒë·ªìng & Y√™u c·∫ßu</span>
        </div>
        <div class="fm-step"
             th:classappend="${request.status == 'ready_to_pay' or request.status == 'paid'} ? ' fm-step--active' : ''">
            <span>2. Thanh to√°n</span>
        </div>
        <div class="fm-step"
             th:classappend="${request.status == 'in_progress'} ? ' fm-step--active' : ''">
            <span>3. Th·ª±c hi·ªán</span>
        </div>
        <div class="fm-step"
             th:classappend="${request.status == 'completed'} ? ' fm-step--active' : ''">
            <span>4. Ho√†n t·∫•t</span>
        </div>
        <div class="fm-step">
            <span>5. ƒê√°nh gi√°</span>
        </div>
    </div>

    <div class="fm-detail-layout">

        <!-- C·ªôt tr√°i: th√¥ng tin y√™u c·∫ßu -->
        <section class="fm-card fm-card--primary">
            <div class="fm-card-header">
                <div class="fm-card-title">Y√™u c·∫ßu d·ªãch v·ª•</div>
                <div class="fm-card-subtitle">
                    Y√™u c·∫ßu #<span th:text="${request.requestId}">1</span>
                </div>
            </div>

            <!-- Tr·∫°ng th√°i & l·ªãch h·∫πn -->
            <div class="fm-section">
                <div class="fm-section-title">Tr·∫°ng th√°i & l·ªãch h·∫πn</div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">Tr·∫°ng th√°i y√™u c·∫ßu</div>
                        <div>
                            <!-- ‚úÖ js-status ƒë·ªÉ realtime c·∫≠p nh·∫≠t -->
                            <span class="fm-badge fm-badge--request js-status"
                                  th:classappend="' status-' + ${request.status}">
                                <span class="fm-badge-dot"></span>
                                <!-- Hi·ªÉn th·ªã th√¢n thi·ªán -->
                                <span th:text="${
                                        request.status == 'pending' ? 'ƒêang ch·ªù x√°c nh·∫≠n' :
                                        request.status == 'ready_to_pay' ? 'Ch·ªù thanh to√°n' :
                                        request.status == 'paid' ? 'ƒê√£ thanh to√°n' :
                                        request.status == 'in_progress' ? 'ƒêang th·ª±c hi·ªán' :
                                        request.status == 'completed' ? 'Ho√†n t·∫•t d·ªãch v·ª•' :
                                        request.status == 'cancelled' ? 'ƒê√£ hu·ª∑' :
                                        request.status
                                }">
                                </span>
                            </span>
                        </div>
                    </div>

                    <!-- üîá ƒê√É B·ªé PH·∫¶N "Tr·∫°ng th√°i thanh to√°n" ·ªû ƒê√ÇY -->
                </div>

                <div class="fm-grid-2col" style="margin-top: 4px;">
                    <div>
                        <div class="fm-label">Ng√†y y√™u c·∫ßu</div>
                        <div class="fm-value"
                             th:text="${#temporals.format(request.requestDate, 'dd/MM/yyyy HH:mm')}">
                            01/11/2025 11:00
                        </div>
                    </div>
                    <div>
                        <div class="fm-label">Ng√†y ∆∞u ti√™n</div>
                        <div class="fm-value"
                             th:text="${#temporals.format(request.preferredDate, 'dd/MM/yyyy')}">
                            02/11/2025
                        </div>
                    </div>
                    <div>
                        <div class="fm-label">Th·ªùi ƒëi·ªÉm thanh to√°n</div>
                        <!-- ‚úÖ js-paid-at -->
                        <div class="fm-value js-paid-at">
                            <span th:if="${request.paidAt != null}"
                                  th:text="${#temporals.format(request.paidAt, 'dd/MM/yyyy HH:mm')}">
                                01/11/2025 12:00
                            </span>
                            <span th:if="${request.paidAt == null}">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Th√¥ng tin chi ph√≠ -->
            <div class="fm-section">
                <div class="fm-section-title">Chi ph√≠</div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">T·ªïng chi ph√≠</div>
                        <!-- ‚úÖ js-total -->
                        <div class="fm-price-main js-total"
                             th:text="${request.totalCost != null
                                       ? #numbers.formatDecimal(request.totalCost, 0, 'COMMA', 0, 'POINT') + ' ƒë'
                                       : '‚Äî'}">
                            1.000.000 ƒë
                        </div>
                    </div>
                    <div>
                        <div class="fm-label">H√¨nh th·ª©c thanh to√°n</div>
                        <!-- ‚úÖ js-payment-type ƒë·ªÉ realtime -->
                        <div class="fm-value js-payment-type"
                             th:text="${
                                request.paymentType == null ? '‚Äî' :
                                request.paymentType == 'DEPOSIT_20' ? 'ƒê·∫∑t c·ªçc 20%' :
                                request.paymentType == 'FULL' ? 'Thanh to√°n to√†n b·ªô' :
                                request.paymentType
                             }">
                            ƒê·∫∑t c·ªçc 20%
                        </div>
                    </div>
                </div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">S·ªë ti·ªÅn ƒë·∫∑t c·ªçc</div>
                        <!-- ‚úÖ js-deposit -->
                        <div class="fm-value js-deposit"
                             th:text="${request.depositAmount != null
                                       ? #numbers.formatDecimal(request.depositAmount, 0, 'COMMA', 0, 'POINT') + ' ƒë'
                                       : '‚Äî'}">
                            200.000 ƒë
                        </div>
                    </div>
                </div>

                <div class="fm-highlight-box">
                    Chi ph√≠ hi·ªÉn th·ªã ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o. Gi√° cu·ªëi c√πng c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh theo
                    kh·ªëi l∆∞·ª£ng ƒë·ªì ƒë·∫°c th·ª±c t·∫ø, qu√£ng ƒë∆∞·ªùng v√† ƒëi·ªÅu kho·∫£n trong h·ª£p ƒë·ªìng.
                </div>
            </div>

            <!-- ‚≠êÔ∏è KHU V·ª∞C ƒê√ÅNH GI√Å D·ªäCH V·ª§ -->
            <div class="fm-section js-rating-section" id="rating-section" style="display:none;">

                <div class="fm-section-title d-flex justify-content-between align-items-center">
                    <span>ƒê√°nh gi√° d·ªãch v·ª•</span>
                    <!-- N√∫t ƒë√≥ng khung rating -->
                    <button type="button"
                            class="btn btn-sm btn-link text-muted js-rating-close">
                        <i class="fa fa-times"></i> ƒê√≥ng
                    </button>
                </div>

                <div class="fm-row">
                    <div class="fm-label">M·ª©c ƒë·ªô h√†i l√≤ng</div>
                    <div class="fm-value">
                        <div id="rating-stars" class="rating-stars js-rating-stars">
                            <i class="fa fa-star star" data-value="1"></i>
                            <i class="fa fa-star star" data-value="2"></i>
                            <i class="fa fa-star star" data-value="3"></i>
                            <i class="fa fa-star star" data-value="4"></i>
                            <i class="fa fa-star star" data-value="5"></i>
                        </div>
                        <div class="fm-rating-note">
                            Ch·ªçn t·ª´ 1 ƒë·∫øn 5 sao (1: R·∫•t kh√¥ng h√†i l√≤ng, 5: R·∫•t h√†i l√≤ng)
                        </div>
                    </div>
                </div>

                <div class="fm-row" style="margin-top: 8px;">
                    <div class="fm-label">G√≥p √Ω th√™m (kh√¥ng b·∫Øt bu·ªôc)</div>
                    <div class="fm-value" style="width:100%;">
                        <textarea id="rating-comment"
                                  class="form-control js-rating-comment"
                                  rows="3"
                                  placeholder="V√≠ d·ª•: Nh√¢n vi√™n th√¢n thi·ªán, ƒë·∫øn ƒë√∫ng gi·ªù, ƒë·ªì ƒë·∫°c ƒë∆∞·ª£c b·∫£o qu·∫£n t·ªët..."></textarea>
                    </div>
                </div>

                <div class="fm-row" style="margin-top: 8px;">
                    <button type="button"
                            id="rating-submit-btn"
                            class="fm-btn-primary js-rating-submit">
                        G·ª≠i ƒë√°nh gi√°
                    </button>
                </div>

                <div class="fm-row" style="margin-top: 4px;">
                    <small id="rating-status"
                           class="text-muted js-rating-status"></small>
                </div>
            </div>
            <!-- H·∫øt khu v·ª±c rating -->

            <!-- C√≥ th·ªÉ th√™m ƒê·ªãa ch·ªâ, ƒê·ªì ƒë·∫°c... -->

        </section>

        <!-- C·ªôt ph·∫£i: t√≥m t·∫Øt Hƒê & h√†nh ƒë·ªông -->
        <aside class="fm-card fm-card--side">

            <div class="fm-card-header">
                <div class="fm-card-title">T·ªïng quan</div>
                <div class="fm-card-subtitle">H·ª£p ƒë·ªìng & thanh to√°n</div>
            </div>

            <!-- Th√¥ng tin H·ª£p ƒë·ªìng -->
            <div class="fm-section">
                <div class="fm-section-title">H·ª£p ƒë·ªìng</div>

                <div class="fm-row">
                    <div>
                        <div class="fm-label">M√£ h·ª£p ƒë·ªìng</div>
                    </div>
                    <div class="fm-value">
                        <!-- ‚úÖ js-contract-id -->
                        <span class="js-contract-id"
                              th:if="${contract != null}"
                              th:text="${contract.contractId}">101</span>
                        <span th:if="${contract == null}">Ch∆∞a c√≥</span>
                    </div>
                </div>

                <div class="fm-row" th:if="${contract != null}">
                    <div>
                        <div class="fm-label">Tr·∫°ng th√°i Hƒê</div>
                    </div>
                    <div class="fm-value">
                        <!-- ‚úÖ js-contract-status -->
                        <span class="fm-badge fm-badge--contract js-contract-status">
                            <span class="fm-badge-dot"></span>
                            <span th:text="${
                                contract.status == 'draft' ? 'Ch∆∞a k√Ω' :
                                contract.status == 'signed' ? 'ƒê√£ k√Ω' :
                                contract.status == 'acknowledged' ? 'ƒê∆°n v·ªã v·∫≠n chuy·ªÉn ƒë√£ x√°c nh·∫≠n' :
                                contract.status == 'cancelled' ? 'H·ª£p ƒë·ªìng b·ªã hu·ª∑' :
                                contract.status
                            }">
                                ƒê√£ k√Ω
                            </span>
                        </span>
                    </div>
                </div>

                <div class="fm-grid-2col" th:if="${contract != null}">
                    <div>
                        <div class="fm-label">Ng√†y k√Ω Hƒê</div>
                        <!-- ‚úÖ js-contract-signed -->
                        <div class="fm-value js-contract-signed">
                            <span th:if="${contract.signedAt != null}"
                                  th:text="${#temporals.format(contract.signedAt, 'dd/MM/yyyy HH:mm')}">
                                01/11/2025 10:00
                            </span>
                            <span th:if="${contract.signedAt == null}">‚Äî</span>
                        </div>
                    </div>

                    <div>
                        <div class="fm-label">ƒê∆°n v·ªã v·∫≠n chuy·ªÉn x√°c nh·∫≠n</div>
                        <!-- ‚úÖ js-contract-ack -->
                        <div class="fm-value js-contract-ack">
                            <span th:if="${contract.acknowledgedAt != null}"
                                  th:text="${#temporals.format(contract.acknowledgedAt, 'dd/MM/yyyy HH:mm')}">
                                01/11/2025 10:15
                            </span>
                            <span th:if="${contract.acknowledgedAt == null}">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- H√†nh ƒë·ªông -->
            <div class="fm-section">
                <div class="fm-section-title">H√†nh ƒë·ªông</div>

                <div class="fm-actions">
                    <!-- N√∫t ‚Äúƒêi ƒë·∫øn thanh to√°n‚Äù (JS s·∫Ω t·ª± ·∫©n/hi·ªán realtime, c√≥ th·ªÉ gi·ªØ ƒëi·ªÅu ki·ªán server n·∫øu mu·ªën) -->
                    <a id="btn-payment"
                       class="fm-btn-primary js-payment-btn"
                       th:href="@{|/payment/${request.requestId}|}"
                       th:attr="data-can-pay=${(request.status == 'ready_to_pay'
                                                and contract != null
                                                and contract.status == 'acknowledged') ? 'true' : 'false'}"
                       th:style="${(request.status == 'ready_to_pay'
                                    and contract != null
                                    and contract.status == 'acknowledged')
                                    ? '' : 'display:none;'}">
                        ƒêi ƒë·∫øn thanh to√°n
                    </a>

                    <!-- N√∫t "Xem h·ª£p ƒë·ªìng" -->
                    <a class="fm-btn-ghost"
                       th:if="${contract != null}"
                       th:href="@{|/contract/${contract.contractId}|}">
                        Xem h·ª£p ƒë·ªìng
                    </a>

                    <!-- ‚úÖ N√∫t "ƒê√°nh gi√°" (JS s·∫Ω t·ª± ·∫©n/hi·ªán t√πy status) -->
                    <button type="button"
                            id="open-rating-btn"
                            class="fm-btn-ghost js-rating-open"
                            style="display:none;">
                        ƒê√°nh gi√°
                    </button>
                </div>
            </div>

        </aside>
    </div>

    <a th:href="@{/customer/requests}" class="fm-back-link">
        ‚Üê Quay l·∫°i danh s√°ch
    </a>
</div>

<!-- ‚úÖ JS realtime cho trang detail + rating -->
<script th:src="@{/customer/js/request-detail.js}"></script>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>

<!-- JavaScript Libraries for navbar and footer -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/homepage/lib/wow/wow.min.js}"></script>
<script th:src="@{/homepage/js/main.js}"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Thanh to√°n ƒë∆°n h√†ng</title>

  <!-- Metadata cho JS -->
  <meta name="request-id" th:content="${requestId}"/>
  <meta name="total-cost" th:content="${amount}"/>
  <!-- üîπ PaymentRef cho JS / ƒë·ªëi so√°t -->
  <meta name="payment-ref" th:content="${paymentRef}"/>

  <!-- CSRF: ch·ªâ render n·∫øu ƒëang b·∫≠t -->
  <th:block th:if="${_csrf != null}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  </th:block>

  <!-- CSS & JS -->
  <link rel="stylesheet" th:href="@{/payment/css/payment.css}"/>
  <script th:src="@{/payment/js/payment.js}" defer></script>
</head>

<body class="payment-body page-payment"><!-- scope CSS -->

  <!-- ====== Fragments ====== -->
  <div th:replace="fragments/header :: topbar"></div>
  <div th:replace="fragments/navbar :: navbar"></div>

  <!-- ====== Payment Content ====== -->
  <div class="payment-page">
    <!-- Header -->
    <header class="payment-header" role="banner">
      <div class="brand">
        <div class="logo-circle" aria-hidden="true">FM</div>
        <div class="brand-text">
          <h1>Furniture Transport</h1>
          <p>Thanh to√°n ƒë∆°n v·∫≠n chuy·ªÉn</p>
        </div>
      </div>

      <div class="order-mini">
        <div class="order-id">
          M√£ ƒë∆°n: <span th:text="${requestId}">123</span>
        </div>
        <div class="order-status" th:text="${status}">PENDING</div>
      </div>
    </header>

    <!-- Layout ch√≠nh -->
    <main class="payment-layout" role="main">
      <!-- Tr√°i: th√¥ng tin ƒë∆°n (card) -->
      <section class="order-summary-card card">
        <div class="hd">
          <h2>Th√¥ng tin ƒë∆°n v·∫≠n chuy·ªÉn</h2>
        </div>
        <div class="bd">
          <div class="summary-row">
            <span>Nh√† cung c·∫•p:</span>
            <strong th:text="${providerCompanyName} ?: 'ƒêang x·ª≠ l√Ω'">T√™n nh√† cung c·∫•p</strong>
          </div>

          <div class="summary-row">
            <span>Gi√° c·∫ßn thanh to√°n:</span>
            <strong id="amountValue"
                    th:text="${#numbers.formatDecimal(amount, 0, 'COMMA', 0, 'POINT')} + ' ƒë'">0 ƒë</strong>
          </div>

          <!-- üîπ N·ªôi dung chuy·ªÉn kho·∫£n (REQid) ƒë·ªÉ ƒë·ªëi so√°t sao k√™ -->
          <div class="summary-row payment-ref-row">
            <span>N·ªôi dung chuy·ªÉn kho·∫£n:</span>
            <span class="payment-ref-inline">
              <code id="paymentRefText"
                    class="payment-ref-chip"
                    th:text="${paymentRef}">REQ123</code>
              <button type="button"
                      id="btnCopyPaymentRef"
                      class="btn-copy-ref">
                Copy
              </button>
            </span>
          </div>

          <div class="summary-note small">
            Vui l√≤ng gi·ªØ nguy√™n n·ªôi dung <strong th:text="${paymentRef}">REQ123</strong>
            khi chuy·ªÉn kho·∫£n ƒë·ªÉ h·ªá th·ªëng v√† nh√† cung c·∫•p d·ªÖ d√†ng ƒë·ªëi so√°t trong sao k√™ ng√¢n h√†ng.
          </div>

          <div class="summary-row">
            <span>Ng√†y t·∫°o ƒë∆°n:</span>
            <span th:text="${#temporals.format(createdAt, 'dd/MM/yyyy HH:mm')}">2025-11-09 10:00</span>
          </div>

          <div class="summary-row">
            <span>Ng√†y v·∫≠n chuy·ªÉn d·ª± ki·∫øn:</span>
            <span th:text="${#temporals.format(expectedDate, 'dd/MM/yyyy')} ?: '-'">-</span>
          </div>

          <div class="summary-row">
            <span>S·ªë l∆∞·ª£ng ƒë·ªì:</span>
            <span th:text="${itemCount} ?: 0">0</span>
          </div>

          <div class="summary-row">
            <span>S·ªë ·∫£nh minh h·ªça:</span>
            <span th:text="${imageCount} ?: 0">0</span>
          </div>

          <div class="address-block">
            <h3>ƒêi·ªÉm nh·∫≠n h√†ng</h3>
            <p th:text="${pickupText} ?: '‚Äî'">ƒê·ªãa ch·ªâ nh·∫≠n‚Ä¶</p>
          </div>

          <div class="address-block">
            <h3>ƒêi·ªÉm giao h√†ng</h3>
            <p th:text="${deliveryText} ?: '‚Äî'">ƒê·ªãa ch·ªâ giao‚Ä¶</p>
          </div>

          <div class="summary-note">
            Sau khi thanh to√°n th√†nh c√¥ng, ƒë∆°n c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang b∆∞·ªõc x·ª≠ l√Ω ti·∫øp theo.
          </div>
        </div>
      </section>

      <!-- Ph·∫£i: VietQR + tr·∫°ng th√°i (card) -->
      <section class="payment-panel-card card" aria-labelledby="qrTitle">
        <div class="hd">
          <h2 id="qrTitle">Thanh to√°n qua VietQR</h2>
        </div>
        <div class="bd">
          <!-- Payment Type Selection -->
          <div class="payment-type-selection" style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n:</h3>
            <div style="display: flex; gap: 15px;">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="paymentType" value="DEPOSIT" id="paymentTypeDeposit" style="margin-right: 8px;">
                <span>ƒê·∫∑t c·ªçc (20%)</span>
              </label>
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="paymentType" value="FULL" id="paymentTypeFull" checked style="margin-right: 8px;">
                <span>Thanh to√°n ƒë·∫ßy ƒë·ªß (100%)</span>
              </label>
            </div>
          </div>

          <div class="qr-wrapper">
            <div id="qrBox" class="qr-box" aria-live="polite">
              <!-- JS s·∫Ω thay n·ªôi dung; gi·ªØ fallback noscript -->
              <noscript><div class="qr-skeleton">Vui l√≤ng b·∫≠t JavaScript ƒë·ªÉ xem m√£ QR.</div></noscript>
            </div>

            <div class="status-area">
              <div id="statusText" class="status-text" role="status">
                ƒêang t·∫°o phi√™n thanh to√°n, vui l√≤ng ch·ªù...
              </div>
              <div id="countdown" class="countdown-text" aria-live="polite"></div>
            </div>
          </div>

          <div class="actions">
            <button id="retryButton" type="button" class="btn-outline" aria-label="T·∫°o l·∫°i m√£ QR">T·∫°o l·∫°i QR</button>
          </div>

          <div class="tips">
            <h3>H∆∞·ªõng d·∫´n nhanh</h3>
            <ol>
              <li>M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng c√≥ h·ªó tr·ª£ VietQR.</li>
              <li>Ch·ªçn ch·ª©c nƒÉng qu√©t m√£ QR.</li>
              <li>Qu√©t m√£ b√™n c·∫°nh v√† x√°c nh·∫≠n thanh to√°n.</li>
              <li>Gi·ªØ nguy√™n trang ƒë·∫øn khi tr·∫°ng th√°i chuy·ªÉn sang <b>‚ÄúThanh to√°n th√†nh c√¥ng‚Äù</b>.</li>
            </ol>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ====== Footer (Fragment) ====== -->
  <div th:replace="fragments/footer :: footer"></div>

  <!-- üîπ JS nh·ªè ƒë·ªÉ copy REQ(id) v√†o clipboard -->
  <script>
    (() => {
      const btn  = document.getElementById("btnCopyPaymentRef");
      const code = document.getElementById("paymentRefText");
      if (!btn || !code) return;

      btn.addEventListener("click", async () => {
        const text = code.textContent.trim();
        if (!text) return;
        try {
          await navigator.clipboard.writeText(text);
          const old = btn.textContent;
          btn.textContent = "ƒê√£ copy!";
          setTimeout(() => btn.textContent = old, 1500);
        } catch (e) {
          console.error(e);
          alert("Kh√¥ng copy ƒë∆∞·ª£c, vui l√≤ng t·ª± ghi: " + text);
        }
      });
    })();
  </script>

</body>
</html>

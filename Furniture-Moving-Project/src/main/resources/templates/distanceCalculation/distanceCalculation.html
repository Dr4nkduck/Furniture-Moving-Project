<!--<!DOCTYPE html>-->
<!--<html lang="vi">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <title>Furniture Moving ‚Äì Qu√£ng ƒë∆∞·ªùng & B√°o gi√°</title>-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->

<!--    &lt;!&ndash; Leaflet &ndash;&gt;-->
<!--    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>-->
<!--    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>-->

<!--    &lt;!&ndash; Routing Machine &ndash;&gt;-->
<!--    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>-->
<!--    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>-->

<!--    &lt;!&ndash; CSS ri√™ng &ndash;&gt;-->
<!--    <link rel="stylesheet" href="/distanceCalculation/style.css">-->


<!--</head>-->
<!--<body>-->
<!--&lt;!&ndash; üîë Auth &ndash;&gt;-->
<!--<div class="topbar" id="authArea">-->
<!--    <a href="/login" class="login-btn">ƒêƒÉng nh·∫≠p</a>-->
<!--</div>-->

<!--<div class="container">-->
<!--    <h2>Furniture Moving</h2>-->

<!--    &lt;!&ndash; Form nh·ªè ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªânh tay n·∫øu mu·ªën (kh√¥ng submit v·ªÅ server) &ndash;&gt;-->
<!--    <form id="addressForm">-->
<!--        <label>ƒê·ªãa ch·ªâ l·∫•y h√†ng:</label>-->
<!--        <input type="text" id="pickup" name="pickup" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ l·∫•y h√†ng" required>-->

<!--        <label>ƒê·ªãa ch·ªâ giao h√†ng:</label>-->
<!--        <input type="text" id="destination" name="destination" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng" required>-->

<!--        <button type="submit">üîç T√¨m ƒë∆∞·ªùng & B√°o gi√°</button>-->
<!--    </form>-->

<!--    <label>D·ªãch v·ª• v·∫≠n chuy·ªÉn:</label>-->
<!--    <select id="serviceSelect">-->
<!--        <option value="">&#45;&#45; Ch·ªçn d·ªãch v·ª• &#45;&#45;</option>-->
<!--        <option value="Xe b√°n t·∫£i nh·ªè">Xe b√°n t·∫£i nh·ªè</option>-->
<!--        <option value="Xe 3.5 t·∫•n">Xe 3.5 t·∫•n</option>-->
<!--        <option value="Xe 5 t·∫•n">Xe 5 t·∫•n</option>-->
<!--    </select>-->

<!--    <label>-->
<!--        <input type="checkbox" id="hasElevator">-->
<!--        üè¢ Chung c∆∞ c√≥ thang m√°y (gi·∫£m 20% chi ph√≠ b·ªëc v√°c)-->
<!--    </label>-->

<!--    <label>Ng√†y v√† gi·ªù v·∫≠n chuy·ªÉn:</label>-->
<!--    <input type="datetime-local" id="pickupTime">-->

<!--    <label>Ch·ª•p ·∫£nh h√†ng h√≥a (AI ∆∞·ªõc l∆∞·ª£ng):</label>-->
<!--    <input type="file" id="uploadImage" accept="image/*">-->
<!--    <div id="aiNote"></div>-->

<!--    <div id="map"></div>-->

<!--    <div id="result">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>-->

<!--    <div id="payment">T·ªïng thanh to√°n: 0 ƒë</div>-->
<!--    <button class="pay-btn" id="btnConfirm" disabled>‚úÖ X√°c nh·∫≠n thanh to√°n</button>-->

<!--    <div id="alert" class="alert" style="display:none;"></div>-->
<!--</div>-->

<!--&lt;!&ndash; JS ri√™ng (t·∫•t c·∫£ logic n·∫±m ·ªü ƒë√¢y) &ndash;&gt;-->
<!--<script src="/distanceCalculation/script.js"></script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o gi√° & L∆∞u y√™u c·∫ßu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <style>
        :root{--bd:#e5e7eb;--txt:#0f172a;--muted:#64748b;--bg:#fafafa;}
        *{box-sizing:border-box}
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;color:var(--txt);background:var(--bg)}
        .container{max-width:1000px;margin:24px auto;background:#fff;border:1px solid var(--bd);border-radius:14px;padding:20px}
        h1{margin:0 0 6px}
        .muted{color:var(--muted);font-size:.95rem}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .card{display:flex;flex-direction:column;gap:6px;border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff}
        input,select{padding:10px;border:1px solid var(--bd);border-radius:10px;font:inherit;background:#fff}
        #map{height:420px;margin-top:12px;border-radius:12px;border:1px solid var(--bd)}
        .alert{display:none;margin-top:10px;padding:10px 12px;border-radius:10px}
        .btn-row{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
        .btn{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#f8fafc;cursor:pointer}
        .btn-primary{background:#2563eb;color:#fff;border-color:#2563eb}
        .payment{margin-top:6px;font-weight:700}
    </style>
</head>
<body>
<div class="container">
    <h1>üßÆ B√°o gi√° & L∆∞u y√™u c·∫ßu</h1>
    <p class="muted">Trang n√†y ƒë·ªçc d·ªØ li·ªáu t·ª´ trang tr∆∞·ªõc, t·ª± v·∫Ω route & t√≠nh chi ph√≠. B·∫•m ‚ÄúX√°c nh·∫≠n & L∆∞u‚Äù ƒë·ªÉ ghi v√†o DB.</p>

    <div id="alert" class="alert"></div>

    <div class="grid2">
        <div class="card">
            <label>üì¶ L·∫•y h√†ng</label>
            <input id="pickup" readonly>
        </div>
        <div class="card">
            <label>üè† Giao h√†ng</label>
            <input id="destination" readonly>
        </div>
    </div>

    <div class="grid2" style="margin-top:12px">
        <div class="card">
            <label>D·ªãch v·ª• / Lo·∫°i xe</label>
            <select id="serviceSelect">
                <option value="">-- Ch·ªçn --</option>
                <option value="Xe b√°n t·∫£i nh·ªè">Xe b√°n t·∫£i nh·ªè</option>
                <option value="Xe 3.5 t·∫•n">Xe 3.5 t·∫•n</option>
                <option value="Xe 5 t·∫•n">Xe 5 t·∫•n</option>
            </select>
        </div>
        <div class="card">
            <label>Ng√†y & gi·ªù v·∫≠n chuy·ªÉn</label>
            <input type="datetime-local" id="pickupTime">
            <label style="color:#64748b"><input type="checkbox" id="hasElevator"> üè¢ Chung c∆∞ c√≥ thang m√°y</label>
        </div>
    </div>

    <div id="map"></div>

    <div id="result" style="margin-top:12px">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y‚Ä¶</div>
    <div id="payment" class="payment">T·ªïng thanh to√°n: 0 ƒë</div>

    <div class="btn-row">
        <button class="btn" onclick="history.back()">‚¨ÖÔ∏è Quay l·∫°i ch·ªânh</button>
        <button class="btn btn-primary" id="btnConfirm" disabled>‚úÖ X√°c nh·∫≠n & L∆∞u</button>
    </div>
</div>

<script>
    /* ====== CONFIG ====== */
    const OSRM_URL = 'https://router.project-osrm.org/route/v1';
    const DRAFT_KEY = 'FT_REQUEST_DRAFT';
    const API_BASE = 'http://localhost:8080'; // gi·ªëng file c·ªßa b·∫°n
    const basePrices = {"Xe b√°n t·∫£i nh·ªè":200000,"Xe 3.5 t·∫•n":300000,"Xe 5 t·∫•n":350000};

    /* ====== STATE ====== */
    let map, routingControl;
    let selectedService = "";
    let lastDistance = 0, lastTime = 0, totalCost = 0;
    let pickupAlley = 0, deliveryAlley = 0;
    let draft = null;

    /* ====== UI helpers ====== */
    function showAlert(msg, ok=false){
        const box = document.getElementById('alert');
        box.style.display='block';
        box.style.background = ok ? '#dcfce7' : '#fee2e2';
        box.style.color = ok ? '#166534' : '#991b1b';
        box.textContent = msg;
    }
    function toVND(n){ return Number(n).toLocaleString('vi-VN') + ' ƒë'; }
    function fmtLine(a){ return [a.houseNumber,a.road,a.district,a.province,a.zip].filter(Boolean).join(', '); }

    /* ====== Map & route ====== */
    function initMap(){
        map = L.map('map').setView([21.0285,105.8542], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            maxZoom:19, attribution:'&copy; OpenStreetMap'
        }).addTo(map);
    }
    async function estimateAlleyLengthOSRM(lat, lon){
        try{
            const url = `${OSRM_URL}/driving/${lon},${lat};${lon+0.001},${lat}?overview=full&steps=true`;
            const r = await fetch(url); const data = await r.json();
            if(!data.routes?.length) return 0;
            let km = 0;
            for(const leg of data.routes[0].legs){
                for(const step of leg.steps){
                    const n = (step.name||'').toLowerCase(); const d = step.distance/1000;
                    if(n.includes('ng√µ')||n.includes('ng√°ch')||n.includes('h·∫ªm')||n.includes('hem')||step.mode!=='driving'||d<0.1) km+=d;
                }
            }
            return Math.min(km,1.5);
        }catch{ return 0; }
    }
    async function routeAndQuote(from, to){
        pickupAlley   = await estimateAlleyLengthOSRM(from.lat, from.lng);
        deliveryAlley = await estimateAlleyLengthOSRM(to.lat,   to.lng);

        if (routingControl) map.removeControl(routingControl);
        document.getElementById('result').innerHTML = "üîÑ ƒêang t√≠nh to√°n...";
        document.getElementById('payment').innerHTML = "T·ªïng thanh to√°n: 0 ƒë";

        routingControl = L.Routing.control({
            waypoints:[ L.latLng(from.lat,from.lng), L.latLng(to.lat,to.lng) ],
            routeWhileDragging:false, addWaypoints:false, show:false
        }).addTo(map);

        const url = `${OSRM_URL}/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=false`;
        const res = await fetch(url); const data = await res.json();
        if(!data.routes?.length){ showAlert('Kh√¥ng t√≠nh ƒë∆∞·ª£c tuy·∫øn ƒë∆∞·ªùng'); return; }

        const r = data.routes[0];
        lastDistance = r.distance/1000; // km
        lastTime = r.duration/60;       // ph√∫t

        updateResult();
        showAlert('ƒê√£ t√≠nh to√°n l·ªô tr√¨nh.', true);
    }

    /* ====== Pricing ====== */
    function calculatePrice(distance, service){
        if(!service || !basePrices[service]) return 0;
        if (distance <= 10){
            if (distance <= 4) return basePrices[service];
            return basePrices[service] + (distance - 4) * 50000;
        }
        switch(service){
            case "Xe b√°n t·∫£i nh·ªè": return 800000 + (distance - 10) * 35000;
            case "Xe 3.5 t·∫•n":     return 1000000 + (distance - 10) * 50000;
            case "Xe 5 t·∫•n":       return 1200000 + (distance - 10) * 60000;
            default:               return 1000000 + (distance - 10) * 50000;
        }
    }
    function calcSmallTruckFee(km){
        if(km<=0) return 0;
        if(km<1) return 100000;
        return 100000 + (km-1)*20000;
    }
    function updateResult(){
        if(lastDistance===0 || lastTime===0) return;

        const baseCost = calculatePrice(lastDistance, selectedService);
        const pickupFee = calcSmallTruckFee(pickupAlley);
        const deliveryFee = calcSmallTruckFee(deliveryAlley);
        const totalSmallTruck = pickupFee + deliveryFee;
        totalCost = baseCost + totalSmallTruck;

        let note = "";
        if (selectedService){
            note = (lastDistance<=10)
                ? `üöï N·ªôi th√†nh: ${toVND(basePrices[selectedService]||0)} (4km ƒë·∫ßu) + 50.000ƒë/km sau`
                : `üöõ Ngo·∫°i th√†nh: ${toVND(calculatePrice(10,selectedService))} (10km ƒë·∫ßu) + ƒë∆°n gi√°/km sau`;
        } else {
            note = `‚ö†Ô∏è H√£y ch·ªçn lo·∫°i xe ƒë·ªÉ hi·ªán gi√° ch√≠nh x√°c.`;
        }

        document.getElementById('result').innerHTML = `
  üìç Qu√£ng ƒë∆∞·ªùng: ${lastDistance.toFixed(2)} km<br>
  ‚è±Ô∏è Th·ªùi gian ∆∞·ªõc t√≠nh: ${lastTime.toFixed(1)} ph√∫t<br>
  üöö D·ªãch v·ª•: ${selectedService||'Ch∆∞a ch·ªçn'}<br>
  üöß Ng√µ h·∫πp: L·∫•y ${pickupAlley.toFixed(2)} km ‚Ä¢ Giao ${deliveryAlley.toFixed(2)} km<br>
  üí∞ C∆∞·ªõc ch√≠nh: ${toVND(baseCost)} ‚Ä¢ Ph√≠ xe nh·ªè: ${toVND(totalSmallTruck)}<br>
  <hr>${note}
  <hr><b>T·ªïng t·∫°m t√≠nh: ${toVND(totalCost)}</b>`;
        document.getElementById('payment').textContent = `T·ªïng thanh to√°n: ${toVND(totalCost)}`;

        const ok = !!(selectedService && document.getElementById('pickupTime').value);
        document.getElementById('btnConfirm').disabled = !ok;
    }

    /* ====== Confirm ‚Üí POST backend /api/requests/checkout ====== */
    async function postCheckout(payload){
        const res = await fetch(`${API_BASE}/api/requests/checkout`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            credentials:'include',
            body: JSON.stringify(payload)
        });
        const text = await res.text();
        let json=null; try{ json=JSON.parse(text);}catch{}
        if(!res.ok) throw new Error((json && (json.message||json.error)) || text || 'Checkout failed');
        return json;
    }

    /* ====== Boot ====== */
    (async function(){
        initMap();

        try { draft = JSON.parse(sessionStorage.getItem(DRAFT_KEY)||'null'); } catch { draft = null; }
        if(!draft){ showAlert('Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ trang tr∆∞·ªõc.'); return; }

        // ƒëi·ªÅn t√≥m t·∫Øt
        document.getElementById('pickup').value      = fmtLine(draft.pickup);
        document.getElementById('destination').value = fmtLine(draft.delivery);

        // service + time
        const sel = document.getElementById('serviceSelect');
        sel.value = draft.vehicleType && ["Xe b√°n t·∫£i nh·ªè","Xe 3.5 t·∫•n","Xe 5 t·∫•n"].includes(draft.vehicleType) ? draft.vehicleType : "";
        selectedService = sel.value;
        document.getElementById('pickupTime').value = (draft.preferredDate ? `${draft.preferredDate}T08:00` : '');
        document.getElementById('hasElevator').checked = !!draft.hasElevator;

        // v·∫Ω route
        if (draft?.pickup?.lat && draft?.delivery?.lat){
            await routeAndQuote(
                {lat:draft.pickup.lat, lng:draft.pickup.lng},
                {lat:draft.delivery.lat, lng:draft.delivery.lng}
            );
        } else {
            showAlert('Thi·∫øu to·∫° ƒë·ªô. Quay l·∫°i trang tr∆∞·ªõc ƒë·ªÉ ƒë·∫∑t marker.', false);
        }

        // events
        document.getElementById('serviceSelect').addEventListener('change', e=>{ selectedService=e.target.value; updateResult(); });
        document.getElementById('hasElevator').addEventListener('change', updateResult);
        document.getElementById('pickupTime').addEventListener('change', updateResult);

        // Confirm & L∆∞u (GHI DB b·∫±ng customerId ƒëƒÉng nh·∫≠p)
        document.getElementById('btnConfirm').addEventListener('click', async ()=>{
            try{
                const currentUser = JSON.parse(localStorage.getItem('currentUser')||'{}'); // { userId, customerId, ... }
                const customerId = currentUser?.customerId ?? 1;

                const pickupTime = document.getElementById('pickupTime').value; // yyyy-MM-ddTHH:mm
                if(!selectedService || !pickupTime){ showAlert('Ch·ªçn lo·∫°i xe v√† th·ªùi gian tr∆∞·ªõc khi x√°c nh·∫≠n.', false); return; }

                const payload = {
                    customerId,
                    providerId: draft.providerId ?? null,
                    preferredDate: (draft.preferredDate || (pickupTime.substring(0,10))), // DB b·∫°n d√πng DATE
                    pickupTime: pickupTime, // n·∫øu backend c·∫ßn gi·ªù chi ti·∫øt
                    serviceType: selectedService,
                    hasElevator: !!document.getElementById('hasElevator').checked,

                    // Address (t·ª´ 2 trang)
                    pickupAddress: {
                        streetAddress: [draft.pickup.houseNumber, draft.pickup.road].filter(Boolean).join(' ').trim() || (draft.pickup.district || draft.pickup.province || 'N/A'),
                        city:  draft.pickup.province || 'N/A',
                        state: draft.pickup.district || draft.pickup.province || 'N/A',
                        zipCode: draft.pickup.zip || '00000',
                        latitude: draft.pickup.lat ?? null,
                        longitude: draft.pickup.lng ?? null,
                        addressType: 'Pickup'
                    },
                    deliveryAddress: {
                        streetAddress: [draft.delivery.houseNumber, draft.delivery.road].filter(Boolean).join(' ').trim() || (draft.delivery.district || draft.delivery.province || 'N/A'),
                        city:  draft.delivery.province || 'N/A',
                        state: draft.delivery.district || draft.delivery.province || 'N/A',
                        zipCode: draft.delivery.zip || '00000',
                        latitude: draft.delivery.lat ?? null,
                        longitude: draft.delivery.lng ?? null,
                        addressType: 'Delivery'
                    },

                    // Items (t·ª´ trang tr∆∞·ªõc)
                    furnitureItems: (draft.items||[]).map(x => ({
                        itemType: x.itemType,
                        size: x.size || null,
                        quantity: x.quantity || 1,
                        isFragile: !!x.isFragile,
                        specialHandling: x.specialHandling || null
                    })),

                    // Route & gi√° (t·ª´ trang n√†y)
                    distanceKm: Number(lastDistance.toFixed(2)),
                    durationSec: Math.round(lastTime * 60),
                    totalCost: Math.round(totalCost)
                };

                const resp = await postCheckout(payload);
                showAlert(`‚úÖ ƒê√£ l∆∞u y√™u c·∫ßu #${resp.requestId || resp.data?.requestId || '???'} (status: ${resp.status || resp.data?.status || 'pending'})`, true);
                sessionStorage.removeItem(DRAFT_KEY);
            }catch(err){
                console.error(err);
                showAlert('‚ùå L∆∞u th·∫•t b·∫°i: ' + (err.message || 'Unknown'), false);
            }
        });
    })();
</script>
</body>
</html>


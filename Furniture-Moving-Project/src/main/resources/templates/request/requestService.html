<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>T·∫°o Y√™u C·∫ßu V·∫≠n Chuy·ªÉn N·ªôi Th·∫•t - Furniture Transport</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container {
      max-width: 900px; margin: 0 auto; background: #fff;
      border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,.3); overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; padding:30px; text-align:center;
    }
    .header h1 { font-size:28px; margin-bottom:10px; }
    .header p { font-size:14px; opacity:.9; }
    .form-content { padding: 40px; }
    .section { margin-bottom: 35px; }
    .section-title {
      font-size:20px; color:#333; margin-bottom:20px; padding-bottom:10px;
      border-bottom:2px solid #667eea; display:flex; align-items:center;
    }
    .section-title::before { content:''; width:4px; height:24px; background:#667eea; margin-right:10px; }
    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; color:#555; font-weight:600; font-size:14px; }
    .required { color:#e74c3c; }
    input[type="text"], input[type="date"], input[type="number"], select, textarea {
      width:100%; padding:12px 15px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; transition: all .3s;
    }
    input:focus, select:focus, textarea:focus {
      outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1);
    }
    textarea { resize: vertical; min-height:80px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    .address-card, .item-card {
      background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:15px; border:2px solid #e0e0e0; position:relative;
    }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .card-title { font-weight:600; color:#667eea; font-size:16px; }
    .btn { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; transition:all .3s; }
    .btn-add { background:#667eea; color:#fff; width:100%; margin-top:10px; }
    .btn-add:hover { background:#5568d3; transform: translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,.3); }
    .btn-remove { background:#e74c3c; color:#fff; padding:6px 12px; font-size:12px; }
    .btn-remove:hover { background:#c0392b; }
    .btn-submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; width:100%; padding:15px; font-size:16px; margin-top:20px;
    }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,.4); }
    .checkbox-group { display:flex; align-items:center; gap:10px; margin-top:10px; }
    .checkbox-group input[type="checkbox"] { width:18px; height:18px; cursor:pointer; }
    .checkbox-group label { margin:0; cursor:pointer; font-weight:normal; }
    .alert { padding:15px 20px; border-radius:8px; margin-bottom:20px; display:none; }
    .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

    /* Hint s·ªë ƒëo cho size */
    .size-hint{
      margin-top:6px;
      font-size:12px;
      color:#555;
      display:none;
    }

    @media (max-width: 768px) {
      .row { grid-template-columns: 1fr; }
      .form-content { padding:20px; }
      .header h1 { font-size:22px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöö T·∫°o Y√™u C·∫ßu V·∫≠n Chuy·ªÉn N·ªôi Th·∫•t</h1>
      <p>ƒêi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ ch√∫ng t√¥i ph·ª•c v·ª• b·∫°n t·ªët nh·∫•t</p>
    </div>

    <div class="form-content">
      <div id="alertBox" class="alert"></div>

      <form id="requestForm">
        <!-- Th√¥ng tin chung -->
        <div class="section">
          <h2 class="section-title">Th√¥ng Tin Chung</h2>
          <div class="row">
            <div class="form-group">
              <label>Ng√†y V·∫≠n Chuy·ªÉn <span class="required">*</span></label>
              <input type="date" id="preferredDate" name="preferredDate" required>
            </div>
            <div class="form-group">
              <label>Nh√† Cung C·∫•p (T√πy Ch·ªçn)</label>
              <select id="providerId" name="providerId">
                <option value="">-- Ch·ªçn sau --</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ƒê·ªãa ch·ªâ l·∫•y h√†ng (1 card duy nh·∫•t) -->
        <div class="section">
          <h2 class="section-title">ƒê·ªãa Ch·ªâ L·∫•y H√†ng</h2>
          <div id="pickupAddresses">
            <div class="address-card" data-type="Pickup">
              <div class="card-header">
                <span class="card-title">üì¶ ƒê·ªãa ch·ªâ l·∫•y h√†ng</span>
              </div>
              <div class="form-group">
                <label>ƒê·ªãa Ch·ªâ <span class="required">*</span></label>
                <input type="text" class="street-address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng" required>
              </div>
              <div class="row">
                <div class="form-group">
                  <label>Th√†nh Ph·ªë <span class="required">*</span></label>
                  <input type="text" class="city" placeholder="Th√†nh ph·ªë" required>
                </div>
                <div class="form-group">
                  <label>Qu·∫≠n/Huy·ªán <span class="required">*</span></label>
                  <input type="text" class="state" placeholder="Qu·∫≠n/Huy·ªán" required>
                </div>
              </div>
              <!-- B·ªé M√É B∆ØU ƒêI·ªÜN -->
              <div class="row">
                <div class="form-group">
                  <label>T√™n Li√™n H·ªá</label>
                  <input type="text" class="contact-name" placeholder="(Kh√¥ng b·∫Øt bu·ªôc)">
                </div>
                <div class="form-group">
                  <label>S·ªë ƒêi·ªán Tho·∫°i</label>
                  <input type="text" class="contact-phone" placeholder="(Kh√¥ng b·∫Øt bu·ªôc)">
                </div>
              </div>
              <div class="form-group">
                <label>H∆∞·ªõng D·∫´n ƒê·∫∑c Bi·ªát</label>
                <textarea class="special-instructions" placeholder="V√≠ d·ª•: T·∫ßng 3, kh√¥ng c√≥ thang m√°y..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- ƒê·ªãa ch·ªâ giao h√†ng (1 card duy nh·∫•t) -->
        <div class="section">
          <h2 class="section-title">ƒê·ªãa Ch·ªâ Giao H√†ng</h2>
          <div id="deliveryAddresses">
            <div class="address-card" data-type="Delivery">
              <div class="card-header">
                <span class="card-title">üè† ƒê·ªãa ch·ªâ giao h√†ng</span>
              </div>
              <div class="form-group">
                <label>ƒê·ªãa Ch·ªâ <span class="required">*</span></label>
                <input type="text" class="street-address" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng" required>
              </div>
              <div class="row">
                <div class="form-group">
                  <label>Th√†nh Ph·ªë <span class="required">*</span></label>
                  <input type="text" class="city" placeholder="Th√†nh ph·ªë" required>
                </div>
                <div class="form-group">
                  <label>Qu·∫≠n/Huy·ªán <span class="required">*</span></label>
                  <input type="text" class="state" placeholder="Qu·∫≠n/Huy·ªán" required>
                </div>
              </div>
              <!-- B·ªé M√É B∆ØU ƒêI·ªÜN -->
              <div class="row">
                <div class="form-group">
                  <label>T√™n Li√™n H·ªá</label>
                  <input type="text" class="contact-name" placeholder="(Kh√¥ng b·∫Øt bu·ªôc)">
                </div>
                <div class="form-group">
                  <label>S·ªë ƒêi·ªán Tho·∫°i</label>
                  <input type="text" class="contact-phone" placeholder="(Kh√¥ng b·∫Øt bu·ªôc)">
                </div>
              </div>
              <div class="form-group">
                <label>H∆∞·ªõng D·∫´n ƒê·∫∑c Bi·ªát</label>
                <textarea class="special-instructions" placeholder="V√≠ d·ª•: C·∫ßn g·ªçi tr∆∞·ªõc 30 ph√∫t..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Danh s√°ch ƒë·ªì n·ªôi th·∫•t -->
        <div class="section">
          <h2 class="section-title">Danh S√°ch ƒê·ªì N·ªôi Th·∫•t</h2>
          <div id="furnitureItems">
            <div class="item-card">
              <div class="card-header">
                <span class="card-title">ü™ë M√≥n ƒë·ªì #1</span>
              </div>
              <div class="row">
                <div class="form-group">
                  <label>Lo·∫°i ƒê·ªì <span class="required">*</span></label>
                  <select class="item-type" required>
                    <option value="">-- Ch·ªçn lo·∫°i --</option>
                    <option value="Sofa">Sofa</option>
                    <option value="Bed">Gi∆∞·ªùng</option>
                    <option value="Table">B√†n</option>
                    <option value="Chair">Gh·∫ø</option>
                    <option value="Cabinet">T·ªß</option>
                    <option value="Wardrobe">T·ªß qu·∫ßn √°o</option>
                    <option value="Other">Kh√°c</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>T√™n M√≥n ƒê·ªì</label>
                  <input type="text" class="item-name" placeholder="V√≠ d·ª•: Sofa 3 ch·ªó">
                </div>
              </div>
              <div class="row">
                <div class="form-group">
                  <label>S·ªë L∆∞·ª£ng <span class="required">*</span></label>
                  <input type="number" class="quantity" min="1" value="1" required>
                </div>
                <div class="form-group">
                  <label>K√≠ch Th∆∞·ªõc</label>
                  <select class="size">
                    <option value="">-- Ch·ªçn --</option>
                    <option value="Small" data-dimensions="40x40x40">Nh·ªè (40√ó40√ó40)</option>
                    <option value="Medium" data-dimensions="80x60x60">Trung b√¨nh (80√ó60√ó60)</option>
                    <option value="Large" data-dimensions="120x80x80">L·ªõn (120√ó80√ó80)</option>
                    <option value="Extra Large" data-dimensions="160x100x100">R·∫•t l·ªõn (160√ó100√ó100)</option>
                  </select>
                  <div class="size-hint">S·ªë ƒëo: <span></span> cm</div>
                </div>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" class="is-fragile" id="fragile1">
                <label for="fragile1">ƒê·ªì d·ªÖ v·ª°</label>
              </div>
              <div class="form-group">
                <label>Ghi Ch√∫ ƒê·∫∑c Bi·ªát</label>
                <textarea class="special-handling-notes" placeholder="V√≠ d·ª•: C·∫ßn b·ªçc c·∫©n th·∫≠n..."></textarea>
              </div>
            </div>
          </div>
          <button type="button" class="btn btn-add" onclick="addFurnitureItem()">+ Th√™m M√≥n ƒê·ªì</button>
        </div>

        <button type="submit" class="btn btn-submit">üì§ G·ª≠i Y√™u C·∫ßu</button>
      </form>
    </div>
  </div>

<script>
  // ==== C·∫§U H√åNH API ====
  const API_BASE = 'http://localhost:8080'; // ƒë·ªïi n·∫øu backend ch·∫°y port kh√°c/context-path

  let itemCount = 1;
  let currentUser = null;

  // ==== MOCK LOGIN (ch·ªâ ƒë·ªÉ demo) ====
  function mockLogin() {
    const key = 'currentUser';
    const exists = localStorage.getItem(key);
    if (exists) return JSON.parse(exists);
    const mock = { userId: 2, customerId: 1, username: 'test_customer' };
    localStorage.setItem(key, JSON.stringify(mock));
    return mock;
  }

  // ==== TI·ªÜN √çCH UI ====
  function showAlert(message, type) {
    const alertBox = document.getElementById('alertBox');
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.style.display = 'block';
    setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
    alertBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function setSubmitting(isSubmitting) {
    const submitBtn = document.querySelector('.btn-submit');
    submitBtn.disabled = isSubmitting;
    submitBtn.textContent = isSubmitting ? '‚è≥ ƒêang g·ª≠i...' : 'üì§ G·ª≠i Y√™u C·∫ßu';
  }

  // ==== N·∫†P PROVIDERS ====
  async function loadProviders() {
    try {
      const url = `${API_BASE}/api/providers`;
      const res = await fetch(url, { method: 'GET' });
      const text = await res.text();

      let result;
      try { result = JSON.parse(text); } catch { result = null; }

      const select = document.getElementById('providerId');
      select.innerHTML = '<option value="">-- Ch·ªçn sau --</option>';

      const list =
        Array.isArray(result) ? result :
        (result && Array.isArray(result.data)) ? result.data : [];

      list.forEach(p => {
        const opt = document.createElement('option');
        const id = p.providerId ?? p.id ?? p.provider_id;
        const name = p.companyName ?? p.name ?? p.company_name ?? 'Nh√† cung c·∫•p';
        const rating = (p.rating != null) ? ` ‚≠ê ${p.rating}` : '';
        opt.value = id;
        opt.textContent = `${name}${rating}`;
        select.appendChild(opt);
      });
    } catch (e) {
      console.error('Load providers error:', e);
    }
  }

  // ==== L·∫§Y & ƒêI·ªÄN ƒê·ªäA CH·ªà M·∫∂C ƒê·ªäNH C·ª¶A USER (Pickup) ====
  async function loadDefaultPickupAddress() {
    try {
      if (!currentUser?.customerId) return;

      // d√πng endpoint b·∫°n ƒëang c√≥: GET /api/addresses?userId=
      const res = await fetch(`${API_BASE}/api/addresses?userId=${currentUser.customerId}`, { method: 'GET' });
      if (!res.ok) return;
      const text = await res.text();
      let json; try { json = JSON.parse(text); } catch { json = null; }

      const list =
        Array.isArray(json) ? json :
        (json && Array.isArray(json.data)) ? json.data : [];

      if (!list.length) return;

      const pick = list.find(a => a.isDefault) ||
                   list.find(a => (a.addressType ?? a.address_type) === 'home') ||
                   list[0];

      const pickupCard = document.querySelector('#pickupAddresses .address-card');
      pickupCard.querySelector('.street-address').value = pick.streetAddress ?? pick.street_address ?? '';
      pickupCard.querySelector('.city').value           = pick.city ?? '';
      pickupCard.querySelector('.state').value          = pick.state ?? pick.district ?? '';
    } catch (e) {
      console.warn('Kh√¥ng th·ªÉ t·ª± ƒë·ªông n·∫°p ƒë·ªãa ch·ªâ pickup:', e);
    }
  }

  // ==== TH√äM ITEM UI ====
  function addFurnitureItem() {
    itemCount++;
    const container = document.getElementById('furnitureItems');
    const itemCard = document.createElement('div');
    itemCard.className = 'item-card';
    itemCard.innerHTML = `
      <div class="card-header">
        <span class="card-title">ü™ë M√≥n ƒë·ªì #${itemCount}</span>
        <button type="button" class="btn btn-remove" onclick="this.closest('.item-card').remove()">X√≥a</button>
      </div>
      <div class="row">
        <div class="form-group">
          <label>Lo·∫°i ƒê·ªì <span class="required">*</span></label>
          <select class="item-type" required>
            <option value="">-- Ch·ªçn lo·∫°i --</option>
            <option value="Sofa">Sofa</option>
            <option value="Bed">Gi∆∞·ªùng</option>
            <option value="Table">B√†n</option>
            <option value="Chair">Gh·∫ø</option>
            <option value="Cabinet">T·ªß</option>
            <option value="Wardrobe">T·ªß qu·∫ßn √°o</option>
            <option value="Other">Kh√°c</option>
          </select>
        </div>
        <div class="form-group">
          <label>T√™n M√≥n ƒê·ªì</label>
          <input type="text" class="item-name" placeholder="V√≠ d·ª•: Sofa 3 ch·ªó">
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label>S·ªë L∆∞·ª£ng <span class="required">*</span></label>
          <input type="number" class="quantity" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label>K√≠ch Th∆∞·ªõc</label>
          <select class="size">
            <option value="">-- Ch·ªçn --</option>
            <option value="Small" data-dimensions="40x40x40">Nh·ªè (40√ó40√ó40)</option>
            <option value="Medium" data-dimensions="80x60x60">Trung b√¨nh (80√ó60√ó60)</option>
            <option value="Large" data-dimensions="120x80x80">L·ªõn (120√ó80√ó80)</option>
            <option value="Extra Large" data-dimensions="160x100x100">R·∫•t l·ªõn (160√ó100√ó100)</option>
          </select>
          <div class="size-hint">S·ªë ƒëo: <span></span> cm</div>
        </div>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" class="is-fragile" id="fragile${itemCount}">
        <label for="fragile${itemCount}">ƒê·ªì d·ªÖ v·ª°</label>
      </div>
      <div class="form-group">
        <label>Ghi Ch√∫ ƒê·∫∑c Bi·ªát</label>
        <textarea class="special-handling-notes" placeholder="V√≠ d·ª•: C·∫ßn b·ªçc c·∫©n th·∫≠n..."></textarea>
      </div>
    `;
    container.appendChild(itemCard);

    // g·∫Øn hint ƒë·ªông cho card m·ªõi
    wireSizeHints(itemCard);
  }

  // ==== HINT S·ªê ƒêO (C√ÅCH 2) ====
  function wireSizeHints(root = document) {
    root.querySelectorAll('.item-card').forEach(card => {
      const select = card.querySelector('.size');
      const hint   = card.querySelector('.size-hint');
      const span   = hint?.querySelector('span');
      if (!select || !hint || !span) return;

      const update = () => {
        const dims = select.selectedOptions[0]?.getAttribute('data-dimensions');
        if (dims) {
          span.textContent = dims;
          hint.style.display = 'block';
        } else {
          span.textContent = '';
          hint.style.display = 'none';
        }
      };
      select.removeEventListener('change', update);
      select.addEventListener('change', update);
      update();
    });
  }

  // ==== VALIDATION PH√çA CLIENT ====
  function isFutureOrToday(dateStr) {
    if (!dateStr) return false;
    const d = new Date(dateStr + 'T00:00:00');
    const today = new Date();
    today.setHours(0,0,0,0);
    return d.getTime() >= today.getTime();
  }

  function validateForm() {
    // 1) preferredDate
    const preferredDate = document.getElementById('preferredDate').value;
    if (!isFutureOrToday(preferredDate)) {
      showAlert('‚ùå Ng√†y v·∫≠n chuy·ªÉn ph·∫£i h√¥m nay ho·∫∑c t∆∞∆°ng lai.', 'error');
      return false;
    }

    // 2) ƒë·ªãa ch·ªâ pickup & delivery
    const pickupCard = document.querySelector('#pickupAddresses .address-card');
    const deliveryCard = document.querySelector('#deliveryAddresses .address-card');
    if (!pickupCard || !deliveryCard) {
      showAlert('‚ùå Thi·∫øu ƒë·ªãa ch·ªâ l·∫•y h√†ng ho·∫∑c giao h√†ng.', 'error');
      return false;
    }
    const required = s => s && s.trim().length > 0;

    const pickup = {
      street: pickupCard.querySelector('.street-address')?.value,
      city: pickupCard.querySelector('.city')?.value,
      state: pickupCard.querySelector('.state')?.value
    };
    const delivery = {
      street: deliveryCard.querySelector('.street-address')?.value,
      city: deliveryCard.querySelector('.city')?.value,
      state: deliveryCard.querySelector('.state')?.value
    };

    if (![pickup.street, pickup.city, pickup.state].every(required)) {
      showAlert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß ƒë·ªãa ch·ªâ L·∫§Y H√ÄNG (ƒë∆∞·ªùng, th√†nh ph·ªë, qu·∫≠n/huy·ªán).', 'error');
      return false;
    }
    if (![delivery.street, delivery.city, delivery.state].every(required)) {
      showAlert('‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß ƒë·ªãa ch·ªâ GIAO H√ÄNG (ƒë∆∞·ªùng, th√†nh ph·ªë, qu·∫≠n/huy·ªán).', 'error');
      return false;
    }

    // 3) items
    const cards = [...document.querySelectorAll('#furnitureItems .item-card')];
    if (cards.length === 0) {
      showAlert('‚ùå Vui l√≤ng th√™m √≠t nh·∫•t 1 m√≥n ƒë·ªì.', 'error');
      return false;
    }
    for (const c of cards) {
      const type = c.querySelector('.item-type')?.value;
      const qty = parseInt(c.querySelector('.quantity')?.value || '0', 10);
      if (!required(type)) {
        showAlert('‚ùå M·ªói m√≥n ƒë·ªì ph·∫£i ch·ªçn Lo·∫°i ƒê·ªì.', 'error');
        return false;
      }
      if (!(qty >= 1)) {
        showAlert('‚ùå S·ªë l∆∞·ª£ng m√≥n ƒë·ªì ph·∫£i ‚â• 1.', 'error');
        return false;
      }
    }

    return true;
  }

  // ==== API T·∫†O ADDRESS ====
  async function createAddress(addr, type) {
    const payload = {
      userId: currentUser.customerId,
      addressType: (type === 'pickup') ? 'home' : 'office',
      streetAddress: addr.streetAddress,
      city: addr.city,
      state: addr.state,
      // b·ªè zipCode theo y√™u c·∫ßu (ho·∫∑c ƒë·ªÉ null n·∫øu backend ch·∫•p nh·∫≠n)
      zipCode: null,
      latitude: null,
      longitude: null,
      isDefault: false
    };
    const res = await fetch(`${API_BASE}/api/addresses`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if (!res.ok || !result.success || !result.data?.addressId) {
      throw new Error(result.message || 'Create address failed');
    }
    return result.data.addressId;
  }

  // ==== SUBMIT FORM ====
  document.getElementById('requestForm').addEventListener('submit', async function(e){
    e.preventDefault();
    if (!validateForm()) return;

    setSubmitting(true);

    // l·∫•y ƒë·ªãa ch·ªâ (card ƒë·∫ßu ti√™n m·ªói nh√≥m)
    const pickupCard = document.querySelector('#pickupAddresses .address-card');
    const deliveryCard = document.querySelector('#deliveryAddresses .address-card');

    const pickupAddress = {
      streetAddress: pickupCard.querySelector('.street-address').value,
      city: pickupCard.querySelector('.city').value,
      state: pickupCard.querySelector('.state').value
    };
    const deliveryAddress = {
      streetAddress: deliveryCard.querySelector('.street-address').value,
      city: deliveryCard.querySelector('.city').value,
      state: deliveryCard.querySelector('.state').value
    };

    // gom items g·ª≠i ƒë√∫ng schema backend (k√®m s·ªë ƒëo c·ª• th·ªÉ)
    const furnitureItems = [];
    document.querySelectorAll('#furnitureItems .item-card').forEach(card => {
      const sizeEl = card.querySelector('.size');
      const sizeVal = sizeEl?.value || null;
      const dims = sizeEl?.selectedOptions?.[0]?.getAttribute('data-dimensions') || null;

      furnitureItems.push({
        itemType: card.querySelector('.item-type').value,
        size: sizeVal,
        sizeDimensions: dims, // g·ª≠i th√™m s·ªë ƒëo
        quantity: parseInt(card.querySelector('.quantity').value),
        isFragile: card.querySelector('.is-fragile').checked,
        specialHandling: card.querySelector('.special-handling-notes').value || null
      });
    });

    try {
      // T·∫†O 2 ƒê·ªäA CH·ªà SONG SONG
      const [pickupAddressId, deliveryAddressId] = await Promise.all([
        createAddress(pickupAddress, 'pickup'),
        createAddress(deliveryAddress, 'delivery')
      ]);

      // T·∫†O REQUEST
      const providerIdStr = document.getElementById('providerId').value;
      const payload = {
        customerId: currentUser.customerId,
        providerId: providerIdStr ? parseInt(providerIdStr) : null,
        pickupAddressId,
        deliveryAddressId,
        preferredDate: document.getElementById('preferredDate').value,
        status: 'pending',
        furnitureItems
      };

      const res = await fetch(`${API_BASE}/api/requests`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await res.json();

      if (res.ok && result.success) {
        showAlert(`‚úÖ Y√™u c·∫ßu t·∫°o th√†nh c√¥ng! M√£: #${result.data.requestId}`, 'success');
        setTimeout(() => {
          document.getElementById('requestForm').reset();
          document.querySelectorAll('#furnitureItems .item-card').forEach((c,i)=>{ if(i>0) c.remove(); });
          itemCount = 1;
          wireSizeHints(); // reset hint
        }, 1000);
      } else {
        throw new Error(result.message || 'C√≥ l·ªói khi t·∫°o y√™u c·∫ßu');
      }
    } catch (err) {
      console.error(err);
      showAlert(`‚ùå ${err.message || 'Kh√¥ng th·ªÉ t·∫°o ƒë·ªãa ch·ªâ/y√™u c·∫ßu. Ki·ªÉm tra backend!'}`, 'error');
    } finally {
      setSubmitting(false);
    }
  });


  // ==== INIT ====
  (function init() {
    currentUser = mockLogin(); // n·∫øu ƒë√£ c√≥ session backend, thay b·∫±ng g·ªçi /api/me ƒë·ªÉ l·∫•y customerId
    document.getElementById('preferredDate').min = new Date().toISOString().split('T')[0];
    loadProviders();
    loadDefaultPickupAddress(); // t·ª± n·∫°p ƒë·ªãa ch·ªâ l·∫•y h√†ng (n·∫øu c√≥)
    wireSizeHints(); // g·∫Øn hint cho card #1
  })();
</script>

</body>
</html>

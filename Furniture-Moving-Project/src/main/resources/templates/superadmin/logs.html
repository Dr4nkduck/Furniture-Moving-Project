<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Activity Logs</title>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" th:href="@{/superadmin/superadmin.css}"/>

  <style>
    /* Giữ lại badge sẵn có (đã có trong superadmin.css nhưng để backward compatible) */
    .badge-login { background:#0d6efd; }
    .badge-quote { background:#20c997; }
    .badge-warn  { background:#ffc107; color:#000; }
    .badge-ok    { background:#6c757d; }
    .nowrap { white-space: nowrap; }
    .ip { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">System Activity Logs</h3>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" th:href="@{/super/dashboard}">Dashboard</a>
      <a class="btn btn-outline-primary btn-sm" th:href="@{/homepage}">Trang chủ</a>
    </div>
  </div>

  <!-- Form tìm kiếm -->
  <form class="row g-2 align-items-center mb-3" th:action="@{/super/logs}" method="get">
    <div class="col-sm-8 col-md-6">
      <input class="form-control" type="text" name="q"
             placeholder="Tìm theo type / description / IP…"
             th:value="${q}">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">Tìm</button>
      <a class="btn btn-outline-secondary" th:href="@{/super/logs}">Xóa</a>
    </div>
  </form>

  <!-- Tổng quan -->
  <div class="mb-2 small text-muted">
    <span th:text="'Trang ' + (${pageData.number}+1) + ' / ' + ${pageData.totalPages}">Trang</span>
    ·
    <span th:text="'Tổng: ' + ${pageData.totalElements} + ' bản ghi'">Tổng</span>
    <span th:if="${q != null and !#strings.isEmpty(q)}">
      · Từ khóa: <code th:text="${q}">kw</code>
    </span>
  </div>

  <!-- Bảng log -->
  <div class="table-responsive shadow-sm">
    <table class="table table-hover align-middle bg-white">
      <thead class="table-light">
      <tr>
        <th class="text-center">#</th>
        <th class="nowrap">Thời gian (UTC)</th>
        <th>User ID</th>
        <th>Vai trò</th> <!-- ✅ CỘT MỚI -->
        <th>Type</th>
        <th>Mô tả</th>
        <th>IP</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="log, idx : ${pageData.content}">
        <td class="text-center"
            th:text="${pageData.number * pageData.size + idx.index + 1}">1</td>

        <td class="nowrap"
            th:text="${#temporals.format(log.timestamp, 'yyyy-MM-dd HH:mm:ss')}">2025-01-01 00:00:00</td>

        <td th:text="${log.userId}">2</td>

        <!-- ✅ HIỂN THỊ VAI TRÒ -->
        <td>
          <span th:if="${log.userId == null}" class="text-muted">System</span>
          <span th:if="${log.userId != null}">
            <!-- tách chuỗi rolesMap[userId] thành mảng, rồi render badge theo từng role -->
            <span th:each="r : ${#strings.arraySplit(rolesMap[log.userId], ', ')}"
                  th:switch="${r}">
              <span th:case="'SUPER_ADMIN'" class="badge text-bg-danger me-1" th:text="${r}">SUPER_ADMIN</span>
              <span th:case="'ADMIN'"       class="badge text-bg-primary me-1" th:text="${r}">ADMIN</span>
              <span th:case="'PROVIDER'"    class="badge text-bg-info me-1"    th:text="${r}">PROVIDER</span>
              <span th:case="'CUSTOMER'"    class="badge text-bg-success me-1" th:text="${r}">CUSTOMER</span>
              <span th:case="*"             class="badge text-bg-secondary me-1" th:text="${r}">OTHER</span>
            </span>
          </span>
        </td>

        <td>
          <span th:switch="${#strings.toUpperCase(log.eventType)}">
            <span th:case="'LOGIN'" class="badge badge-login" th:text="${log.eventType}">LOGIN</span>
            <span th:case="'QUOTE'" class="badge badge-quote" th:text="${log.eventType}">QUOTE</span>
            <span th:case="'WARN'"  class="badge badge-warn"  th:text="${log.eventType}">WARN</span>
            <span th:case="*"       class="badge badge-ok"    th:text="${log.eventType}">OTHER</span>
          </span>
        </td>

        <td th:text="${log.eventDescription}">Chi tiết sự kiện…</td>
        <td class="ip" th:text="${log.ipAddress}">127.0.0.1</td>
      </tr>

      <tr th:if="${#lists.isEmpty(pageData.content)}">
        <td colspan="7" class="text-center text-muted py-4">
          Không có dữ liệu.
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Phân trang -->
  <nav class="mt-3" th:if="${pageData.totalPages > 1}">
    <ul class="pagination pagination-sm">
      <li class="page-item" th:classappend="${pageData.first} ? ' disabled'">
        <a class="page-link"
           th:href="@{/super/logs(page=${pageData.number - 1}, q=${q})}">&laquo;</a>
      </li>

      <li class="page-item"
          th:each="p : ${#numbers.sequence(0, pageData.totalPages-1)}"
          th:classappend="${p == pageData.number} ? ' active'">
        <a class="page-link"
           th:text="${p + 1}"
           th:href="@{/super/logs(page=${p}, q=${q})}">1</a>
      </li>

      <li class="page-item" th:classappend="${pageData.last} ? ' disabled'">
        <a class="page-link"
           th:href="@{/super/logs(page=${pageData.number + 1}, q=${q})}">&raquo;</a>
      </li>
    </ul>
  </nav>

</div>

</body>
</html>
